<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moderator Setup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: #fffef7; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px; margin: 0 auto; padding: 40px;
            border: 3px solid #d4af37;
        }
        h1 { color: #c94b4b; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #2d5016; margin-bottom: 30px; font-size: 1.1em; }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #2d5016; font-weight: 600; }
        input[type="text"], textarea {
            width: 100%; padding: 12px; border: 2px solid #d4af37;
            border-radius: 8px; font-size: 16px; background: white;
        }
        input:focus, textarea:focus { outline: none; border-color: #c94b4b; }
        textarea { resize: vertical; min-height: 80px; }
        button {
            background: #c94b4b; color: white; border: none;
            padding: 14px 28px; border-radius: 8px; font-size: 16px;
            font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px;
            transition: all 0.3s;
        }
        button:hover { background: #a83939; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .question-list { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .question-item {
            background: #f0f8e8; padding: 15px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #2d5016;
        }
        .question-item strong { color: #c94b4b; display: block; margin-bottom: 5px; }
        .question-actions { display: flex; gap: 10px; margin-top: 10px; }
        .edit-btn, .delete-btn { width: auto; padding: 8px 15px; font-size: 14px; margin-top: 0; }
        .edit-btn { background: #2d5016; }
        .delete-btn { background: #8b0000; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .option {
            background: white; padding: 20px; border-radius: 12px;
            border: 3px solid #d4af37; text-align: center;
            font-weight: 600; color: #2d5016; font-size: 1.1em;
        }
        .progress { background: #e8dcc4; height: 8px; border-radius: 4px; margin-bottom: 20px; }
        .progress-bar { background: linear-gradient(90deg, #c94b4b 0%, #2d5016 100%); height: 100%; transition: width 0.3s; }
        .question-header {
            background: linear-gradient(135deg, #c94b4b 0%, #2d5016 100%);
            color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center;
        }
        .question-number { font-size: 1.1em; opacity: 0.9; margin-bottom: 15px; }
        .question-text { font-size: 1.8em; font-weight: 600; line-height: 1.4; }
        .answer-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .correct-indicator { color: #2d5016; font-weight: 600; margin-left: 5px; }
        .error-message { background: #ffe6e6; color: #8b0000; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .error-message.show { display: block; }
        .success-message { background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .success-message.show { display: block; }
        .leaderboard-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: white; border-radius: 12px;
            margin-bottom: 15px; border-left: 6px solid #d4af37;
        }
        .leaderboard-item.first { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-left-width: 8px; }
        .leaderboard-item.second { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); border-left-width: 8px; }
        .leaderboard-item.third { background: linear-gradient(135deg, #cd7f32 0%, #e6a85c 100%); border-left-width: 8px; }
        .player-name { font-weight: 600; font-size: 1.2em; color: #2d5016; }
        .player-score { font-size: 1.5em; font-weight: 700; color: #c94b4b; }
        .score-detail { font-size: 0.9em; color: #666; }
        .rank { font-size: 2em; font-weight: 700; margin-right: 20px; color: #d4af37; }
        .medal { font-size: 2em; margin-right: 10px; }
        .edit-mode { background: #fff9e6; }
        .waiting-room { background: #f0f8e8; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #2d5016; }
        .waiting-room h3 { color: #c94b4b; margin-bottom: 15px; }
        .player-badge {
            display: inline-block; background: #2d5016; color: white;
            padding: 8px 15px; border-radius: 20px; margin: 5px; font-size: 0.95em;
        }
        .next-btn { background: #2d5016; font-size: 1.2em; padding: 18px 35px; }
        .answer-key {
            background: #f0f8e8; padding: 20px; border-radius: 12px;
            margin-top: 30px; border: 2px solid #2d5016;
        }
        .answer-key h3 { color: #c94b4b; margin-bottom: 15px; text-align: center; }
        .answer-item {
            background: white; padding: 12px; border-radius: 8px;
            margin-bottom: 10px; border-left: 4px solid #2d5016;
        }
        .answer-item strong { color: #c94b4b; }
        .answer-item .correct-answer { color: #2d5016; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div id="setupScreen" class="screen active">
            <h1>ü§µ Moderator Setup</h1>
            <p class="subtitle">Manage your quiz questions</p>
            <div class="success-message" id="importSuccess"></div>
            <div class="error-message" id="setupError"></div>
            <div class="input-group">
                <label>Question:</label>
                <textarea id="questionInput" placeholder="e.g., Who received the most recognition this year?"></textarea>
            </div>
            <div class="input-group">
                <label>Answer Options (mark correct with *):</label>
                <div class="answer-input">
                    <input type="text" id="option1" placeholder="Option 1">
                    <input type="text" id="option2" placeholder="Option 2">
                    <input type="text" id="option3" placeholder="Option 3">
                    <input type="text" id="option4" placeholder="Option 4">
                    <input type="text" id="option5" placeholder="Option 5 (optional)">
                </div>
                <small style="color: #2d5016; margin-top: 5px; display: block;">Add * at start of correct answer. Use 2-5 options.</small>
            </div>
            <button onclick="addQuestion()" id="addQuestionBtn">‚ûï Add Question</button>
            <button onclick="cancelEdit()" id="cancelEditBtn" style="display: none; background: #666;">‚ùå Cancel</button>
            <div class="question-list" id="questionList"></div>
            <button onclick="startQuiz()" style="background: #2d5016;">üöÄ Start Quiz</button>
        </div>

        <div id="waitingRoomScreen" class="screen">
            <h1>Waiting Room</h1>
            <p class="subtitle">Players are joining...</p>
            <div class="waiting-room">
                <h3>Players Joined (<span id="playerCount">0</span>):</h3>
                <div id="playersContainer"></div>
            </div>
            <button onclick="readyForQuiz()" style="background: #2d5016; font-size: 1.2em;">‚úÖ Ready For Quiz</button>
        </div>

        <div id="quizScreen" class="screen">
            <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
            <div class="question-header">
                <div class="question-number" id="questionNumber">Question 1</div>
                <div class="question-text" id="questionText">Loading...</div>
            </div>
            <div class="options" id="optionsContainer"></div>
            <button id="nextBtn" onclick="nextQuestion()" class="next-btn" style="margin-top: 30px;">Next Question ‚û°Ô∏è</button>
            <button id="showResultsBtn" onclick="showResults()" style="display: none; margin-top: 30px; background: #2d5016; font-size: 1.2em;">Show Final Results üèÜ</button>
        </div>

        <div id="resultsScreen" class="screen">
            <h1>üèÜ Final Results üèÜ</h1>
            <p class="subtitle">Congratulations!</p>
            <div id="leaderboard" style="margin-bottom: 20px;"></div>
            <div class="answer-key" id="answerKey"></div>
            <button onclick="backToSetup()" style="background: #2d5016;">üîÑ New Quiz</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
              apiKey: "AIzaSyB5fsaq6LVU0For3GNoknwrIQOIpaMNTos",
  authDomain: "assurance-tools-feb.firebaseapp.com",
  databaseURL: "https://assurance-tools-feb-default-rtdb.firebaseio.com",
  projectId: "assurance-tools-feb",
  storageBucket: "assurance-tools-feb.firebasestorage.app",
  messagingSenderId: "683058557557",
  appId: "1:683058557557:web:10a9bd9e63aca06ad7be3c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'game');

        let gameState = { questions: [], currentQuestion: 0 };
        let editingIndex = -1;

        onValue(ref(db, 'game/savedQuestions'), (snapshot) => {
            const data = snapshot.val();
            if (!data || data.length === 0) {
                set(ref(db, 'game/savedQuestions'), savedQuestions).then(() => {
                    const successEl = document.getElementById('importSuccess');
                    successEl.textContent = '‚úÖ Successfully imported 24 questions!';
                    successEl.classList.add('show');
                    setTimeout(() => successEl.classList.remove('show'), 5000);
                    gameState.questions = savedQuestions;
                    updateQuestionList();
                });
            } else {
                gameState.questions = data;
                updateQuestionList();
            }
        }, { onlyOnce: true });

        onValue(ref(db, 'game/players'), (snapshot) => {
            const players = snapshot.val() || {};
            const container = document.getElementById('playersContainer');
            const count = document.getElementById('playerCount');
            const playerNames = Object.values(players).map(p => p.name);
            count.textContent = playerNames.length;
            container.innerHTML = playerNames.length === 0 ? '<p style="color: #666;">Waiting...</p>' : '';
            playerNames.forEach(name => {
                const badge = document.createElement('span');
                badge.className = 'player-badge';
                badge.textContent = name;
                container.appendChild(badge);
            });
        });

        function showError(msg) {
            const el = document.getElementById('setupError');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        window.addQuestion = function() {
            const question = document.getElementById('questionInput').value.trim();
            const options = [
                document.getElementById('option1').value.trim(),
                document.getElementById('option2').value.trim(),
                document.getElementById('option3').value.trim(),
                document.getElementById('option4').value.trim(),
                document.getElementById('option5').value.trim()
            ];

            if (!question) { showError('Please enter a question'); return; }
            const validOptions = options.filter(opt => opt !== '');
            if (validOptions.length < 2) { showError('Please enter at least 2 options'); return; }
            const correctIndex = options.findIndex(opt => opt.startsWith('*'));
            if (correctIndex === -1) { showError('Please mark correct answer with *'); return; }

            const cleanOptions = options.map(opt => opt.replace(/^\*/, '').trim()).filter(opt => opt !== '');
            const cleanCorrectIndex = cleanOptions.findIndex((opt, i) => options[i].startsWith('*'));

            if (editingIndex >= 0) {
                gameState.questions[editingIndex] = { question, options: cleanOptions, correctIndex: cleanCorrectIndex };
                editingIndex = -1;
                document.getElementById('addQuestionBtn').textContent = '‚ûï Add Question';
                document.getElementById('cancelEditBtn').style.display = 'none';
            } else {
                gameState.questions.push({ question, options: cleanOptions, correctIndex: cleanCorrectIndex });
            }

            set(ref(db, 'game/savedQuestions'), gameState.questions);
            for (let i = 1; i <= 5; i++) document.getElementById('option' + i).value = '';
            document.getElementById('questionInput').value = '';
        };

        window.editQuestion = function(index) {
            const q = gameState.questions[index];
            editingIndex = index;
            document.getElementById('questionInput').value = q.question;
            for (let i = 1; i <= 5; i++) document.getElementById('option' + i).value = '';
            q.options.forEach((opt, i) => {
                const input = document.getElementById('option' + (i + 1));
                if (input) input.value = (i === q.correctIndex ? '*' : '') + opt;
            });
            document.getElementById('addQuestionBtn').textContent = 'üíæ Save';
            document.getElementById('cancelEditBtn').style.display = 'block';
        };

        window.cancelEdit = function() {
            editingIndex = -1;
            document.getElementById('addQuestionBtn').textContent = '‚ûï Add Question';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('questionInput').value = '';
            for (let i = 1; i <= 5; i++) document.getElementById('option' + i).value = '';
        };

        window.deleteQuestion = function(index) {
            if (editingIndex === index) window.cancelEdit();
            gameState.questions.splice(index, 1);
            set(ref(db, 'game/savedQuestions'), gameState.questions);
        };

        function updateQuestionList() {
            const list = document.getElementById('questionList');
            list.innerHTML = '<h3 style="margin-bottom: 15px; color: #c94b4b;">Saved: ' + gameState.questions.length + '</h3>';
            gameState.questions.forEach((q, i) => {
                const item = document.createElement('div');
                item.className = 'question-item' + (editingIndex === i ? ' edit-mode' : '');
                item.innerHTML = '<strong>Q' + (i + 1) + ': ' + q.question + '</strong>' +
                    q.options.map((opt, j) => '<div>' + opt + (j === q.correctIndex ? '<span class="correct-indicator">‚úì</span>' : '') + '</div>').join('') +
                    '<div class="question-actions"><button class="edit-btn" onclick="editQuestion(' + i + ')">‚úèÔ∏è Edit</button><button class="delete-btn" onclick="deleteQuestion(' + i + ')">üóëÔ∏è Delete</button></div>';
                list.appendChild(item);
            });
        }

        window.startQuiz = function() {
            if (gameState.questions.length === 0) { showError('Add at least one question'); return; }
            
            // RESET EVERYTHING for new session
            console.log('Starting new quiz session - resetting all data...');
            remove(ref(db, 'game/players'));
            remove(ref(db, 'game/scores'));
            
            update(gameRef, { 
                questions: gameState.questions,
                status: 'waiting',
                currentQuestion: 0
            });
            
            gameState.currentQuestion = 0;
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('waitingRoomScreen').classList.add('active');
        };

        window.readyForQuiz = function() {
            update(gameRef, { status: 'ready', currentQuestion: 0 });
            document.getElementById('waitingRoomScreen').classList.remove('active');
            document.getElementById('quizScreen').classList.add('active');
            displayQuestion();
        };

        function displayQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('showResultsBtn').style.display = 'block';
                return;
            }
            const q = gameState.questions[gameState.currentQuestion];
            const progress = ((gameState.currentQuestion + 1) / gameState.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionNumber').textContent = 'Question ' + (gameState.currentQuestion + 1) + ' of ' + gameState.questions.length;
            document.getElementById('questionText').textContent = q.question;
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            q.options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = option;
                container.appendChild(div);
            });
        }

        window.nextQuestion = function() {
            gameState.currentQuestion++;
            update(gameRef, { currentQuestion: gameState.currentQuestion });
            displayQuestion();
        };

        window.showResults = function() {
            update(gameRef, { status: 'ended' });
            document.getElementById('quizScreen').classList.remove('active');
            document.getElementById('resultsScreen').classList.add('active');
            
            setTimeout(() => {
                onValue(ref(db, 'game/scores'), (snapshot) => {
                    const scores = snapshot.val() || {};
                    const players = Object.values(scores).sort((a, b) => 
                        b.score !== a.score ? b.score - a.score : a.name.localeCompare(b.name)
                    );
                    const leaderboard = document.getElementById('leaderboard');
                    leaderboard.innerHTML = '<h3 style="color: #c94b4b; text-align: center; margin-bottom: 20px;">üèÜ Leaderboard üèÜ</h3>';
                    players.forEach((player, index) => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        let medal = '';
                        if (index === 0) { item.classList.add('first'); medal = 'ü•á'; }
                        else if (index === 1) { item.classList.add('second'); medal = 'ü•à'; }
                        else if (index === 2) { item.classList.add('third'); medal = 'ü•â'; }
                        item.innerHTML = '<div style="display: flex; align-items: center;"><span class="medal">' + medal + '</span><span class="rank">#' + (index + 1) + '</span><span class="player-name">' + player.name + '</span></div><span class="player-score">' + player.score + ' pts <span class="score-detail">(' + player.correct + '/' + player.total + ')</span></span>';
                        leaderboard.appendChild(item);
                    });
                    
                    const answerKey = document.getElementById('answerKey');
                    answerKey.innerHTML = '<h3>üìã Answer Key</h3>';
                    gameState.questions.forEach((q, i) => {
                        const item = document.createElement('div');
                        item.className = 'answer-item';
                        item.innerHTML = '<strong>Q' + (i + 1) + '.</strong> ' + q.question + '<br><span class="correct-answer">Answer: ' + q.options[q.correctIndex] + '</span>';
                        answerKey.appendChild(item);
                    });
                }, { onlyOnce: true });
            }, 2000);
        };

        window.backToSetup = function() {
            // COMPLETE RESET for new quiz
            console.log('Resetting quiz for new session...');
            remove(ref(db, 'game/players'));
            remove(ref(db, 'game/scores'));
            update(gameRef, { status: 'waiting', currentQuestion: 0 });
            gameState.currentQuestion = 0;
            document.getElementById('resultsScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
        };
    </script>
</body>
</html>
