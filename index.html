

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Assurance Team Pop Quiz!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: #fffef7;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            border: 3px solid #d4af37;
        }
        h1 { color: #c94b4b; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #2d5016; margin-bottom: 30px; font-size: 1.1em; }
        .screen { display: none; }
        .screen.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #2d5016; font-weight: 600; }
        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #d4af37;
            border-radius: 8px; font-size: 16px; background: white;
        }
        input[type="text"]:focus { outline: none; border-color: #c94b4b; }
        button {
            background: #c94b4b; color: white; border: none;
            padding: 14px 28px; border-radius: 8px; font-size: 16px;
            font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px;
            transition: all 0.3s;
        }
        button:hover { background: #a83939; transform: translateY(-2px); }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .option {
            background: white; padding: 20px; border-radius: 12px;
            border: 3px solid #d4af37; cursor: pointer; transition: all 0.3s;
            text-align: center; font-weight: 600; color: #2d5016;
        }
        .option:hover { border-color: #c94b4b; background: #fff5f5; transform: translateY(-2px); }
        .option.selected { border-color: #c94b4b; background: #c94b4b; color: white; }
        .progress { background: #e8dcc4; height: 8px; border-radius: 4px; margin-bottom: 20px; }
        .progress-bar { background: linear-gradient(90deg, #c94b4b 0%, #2d5016 100%); height: 100%; transition: width 0.3s; }
        .leaderboard-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: white; border-radius: 12px;
            margin-bottom: 15px; border-left: 6px solid #d4af37;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .leaderboard-item.first { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border-left-width: 8px; }
        .leaderboard-item.second { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); border-left-width: 8px; }
        .leaderboard-item.third { background: linear-gradient(135deg, #cd7f32 0%, #e6a85c 100%); border-left-width: 8px; }
        .leaderboard-item.you { border: 3px solid #c94b4b; box-shadow: 0 4px 15px rgba(201, 75, 75, 0.4); }
        .player-name { font-weight: 600; font-size: 1.2em; color: #2d5016; }
        .player-score { font-size: 1.5em; font-weight: 700; color: #c94b4b; }
        .score-detail { font-size: 0.9em; color: #666; margin-left: 5px; }
        .rank { font-size: 2em; font-weight: 700; margin-right: 20px; color: #d4af37; }
        .medal { font-size: 2em; margin-right: 10px; }
        .waiting { text-align: center; padding: 60px 40px; color: #2d5016; }
        .waiting h2 { color: #c94b4b; margin-bottom: 30px; font-size: 2em; }
        .hourglass { font-size: 80px; animation: flip 2s infinite; display: inline-block; margin: 20px 0; }
        @keyframes flip { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
        .waiting-message { font-size: 1.2em; color: #2d5016; margin-top: 20px; line-height: 1.6; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .question-header {
            background: linear-gradient(135deg, #c94b4b 0%, #2d5016 100%);
            color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;
        }
        .question-number { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .question-text { font-size: 1.4em; font-weight: 600; }
        .error-message { background: #ffe6e6; color: #8b0000; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .error-message.show { display: block; }
        .info-box { background: #f0f8e8; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #2d5016; }
        .info-box h4 { color: #c94b4b; margin-bottom: 10px; }
        .info-box p { color: #2d5016; margin-bottom: 5px; }
        .selection-status {
            text-align: center; margin-top: 15px; padding: 10px;
            background: #f0f8e8; border-radius: 8px; color: #2d5016; font-weight: 600;
        }
        .your-score {
            background: #e7f3ff; padding: 20px; border-radius: 12px;
            text-align: center; margin-bottom: 30px; border: 2px solid #667eea;
        }
        .your-score h3 { color: #c94b4b; font-size: 1.5em; margin-bottom: 10px; }
        .your-score .score { font-size: 2.5em; font-weight: 700; color: #2d5016; }
        .thank-you {
            text-align: center; margin-top: 30px; padding: 20px;
            background: #f0f8e8; border-radius: 12px; border: 2px solid #2d5016;
        }
        .thank-you h3 { color: #c94b4b; margin-bottom: 10px; }
        .thank-you p { color: #2d5016; }
    </style>
</head>
<body>
    <div class="container">
        <div id="joinScreen" class="screen active">
            <h1>Service Assurance Team Pop Quiz!</h1>
            <div class="error-message" id="joinError"></div>
            <div class="input-group">
                <label>Your Name:</label>
                <input type="text" id="playerName" placeholder="Enter your name">
            </div>
            <button onclick="joinQuiz()">Join Quiz</button>
            <div class="info-box">
                <h4>Welcome!</h4>
                <p>Enter your name and wait for the moderator to start the quiz.</p>
                <p>Make sure you can see/hear the moderator's screen!</p>
            </div>
        </div>

        <div id="waitingScreen" class="screen">
            <div class="waiting">
                <h2>Welcome, <span id="waitingPlayerName"></span>!</h2>
                <div class="hourglass">‚è≥</div>
                <div class="waiting-message">
                    <p class="pulse"><strong>Please wait...</strong></p>
                    <p style="margin-top: 15px;">The moderator will start the quiz shortly.</p>
                </div>
            </div>
        </div>

        <div id="quizScreen" class="screen">
            <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
            <div class="question-header">
                <div class="question-number" id="questionNumber">Question 1 of 5</div>
                <div class="question-text" id="questionText">Loading question...</div>
            </div>
            <div class="options" id="optionsContainer"></div>
            <div class="selection-status" id="selectionStatus">Click an option to select your answer.</div>
        </div>

        <div id="resultsScreen" class="screen">
            <h1>üèÜ Final Results üèÜ</h1>
            <p class="subtitle">Great job everyone!</p>
            <div class="your-score">
                <h3>Your Score</h3>
                <div class="score" id="yourScore">0 points</div>
            </div>
            <div style="margin-top: 20px;">
                <h3 style="color: #c94b4b; text-align: center; margin-bottom: 15px;">üèÜ Leaderboard üèÜ</h3>
                <!-- Leaderboard removed -->
            </div>
            <div class="thank-you">
                <h3>üéâ Thank You for Playing! üéâ</h3>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
              apiKey: "AIzaSyB5fsaq6LVU0For3GNoknwrIQOIpaMNTos",
  authDomain: "assurance-tools-feb.firebaseapp.com",
  databaseURL: "https://assurance-tools-feb-default-rtdb.firebaseio.com",
  projectId: "assurance-tools-feb",
  storageBucket: "assurance-tools-feb.firebasestorage.app",
  messagingSenderId: "683058557557",
  appId: "1:683058557557:web:10a9bd9e63aca06ad7be3c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'game');

        let localState = {
            playerName: '',
            playerId: 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            answers: [],
            selectedAnswer: null
        };

        let gameState = { questions: [], currentQuestion: 0, status: 'waiting' };

        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            
            if (data.questions) {
                gameState.questions = data.questions;
                // Only initialize answers array if it's empty (don't reset saved answers!)
                if (localState.answers.length === 0) {
                    localState.answers = new Array(data.questions.length).fill(null);
                    console.log('Initialized answers array with', data.questions.length, 'slots');
                }
            }
            
            if (data.status === 'ready' && document.getElementById('waitingScreen').classList.contains('active')) {
                document.getElementById('waitingScreen').classList.remove('active');
                document.getElementById('quizScreen').classList.add('active');
                gameState.currentQuestion = 0;
                displayQuestion();
            }
            
            if (data.currentQuestion !== undefined && data.currentQuestion !== gameState.currentQuestion && data.status === 'ready') {
                if (localState.selectedAnswer !== null) {
                    localState.answers[gameState.currentQuestion] = localState.selectedAnswer;
                    console.log('Saved answer for Q' + (gameState.currentQuestion + 1) + ':', localState.selectedAnswer);
                }
                gameState.currentQuestion = data.currentQuestion;
                localState.selectedAnswer = null;
                
                if (gameState.currentQuestion >= gameState.questions.length) {
                    console.log('Quiz ended, saving final score...');
                    saveScore();
                } else {
                    displayQuestion();
                }
            }
            
            if (data.status === 'ended') {
                if (localState.selectedAnswer !== null && gameState.currentQuestion < gameState.questions.length) {
                    localState.answers[gameState.currentQuestion] = localState.selectedAnswer;
                }
                saveScore();
                showResults();
            }
        });

        window.joinQuiz = function() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                const errorEl = document.getElementById('joinError');
                errorEl.textContent = 'Please enter your name';
                errorEl.classList.add('show');
                setTimeout(() => errorEl.classList.remove('show'), 3000);
                return;
            }

            localState.playerName = name;
            update(ref(db, 'game/players/' + localState.playerId), { name: name });
            
            document.getElementById('joinScreen').classList.remove('active');
            document.getElementById('waitingScreen').classList.add('active');
            document.getElementById('waitingPlayerName').textContent = name;
        };

        function displayQuestion() {
            if (gameState.currentQuestion >= gameState.questions.length) {
                saveScore();
                return;
            }

            const q = gameState.questions[gameState.currentQuestion];
            const progress = ((gameState.currentQuestion + 1) / gameState.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionNumber').textContent = 'Question ' + (gameState.currentQuestion + 1) + ' of ' + gameState.questions.length;
            document.getElementById('questionText').textContent = q.question;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            const savedAnswer = localState.answers[gameState.currentQuestion];
            if (savedAnswer !== null && savedAnswer !== undefined) {
                localState.selectedAnswer = savedAnswer;
            }
            
            q.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                if (localState.selectedAnswer === index) div.classList.add('selected');
                div.textContent = option;
                div.onclick = () => selectAnswer(index);
                container.appendChild(div);
            });

            updateSelectionStatus();
        }

        function selectAnswer(index) {
            localState.selectedAnswer = index;
            // Save immediately to answers array
            localState.answers[gameState.currentQuestion] = index;
            console.log('‚úì Saved answer for Q' + (gameState.currentQuestion + 1) + ': index=' + index);
            
            const options = document.querySelectorAll('.option');
            options.forEach((opt, i) => {
                opt.classList.remove('selected');
                if (i === index) opt.classList.add('selected');
            });
            updateSelectionStatus();
        }

        function updateSelectionStatus() {
            const statusEl = document.getElementById('selectionStatus');
            if (localState.selectedAnswer !== null) {
                statusEl.textContent = '‚úì Answer selected! You can change it until the moderator moves to the next question.';
                statusEl.style.background = '#e7f3ff';
            } else {
                statusEl.textContent = 'Click an option to select your answer.';
                statusEl.style.background = '#f0f8e8';
            }
        }

        function calculateScore() {
            let correct = 0;
            console.log('Calculating score...');
            console.log('Total questions:', gameState.questions.length);
            console.log('Player answers:', localState.answers);
            
            gameState.questions.forEach((q, index) => {
                const playerAnswer = localState.answers[index];
                const correctAnswer = q.correctIndex;
                console.log('Q' + (index + 1) + ': Player=' + playerAnswer + ', Correct=' + correctAnswer + ', Match=' + (playerAnswer === correctAnswer));
                if (playerAnswer === correctAnswer) {
                    correct++;
                }
            });
            
            console.log('Final: ' + correct + ' correct out of ' + gameState.questions.length);
            return { score: correct * 100, correct, total: gameState.questions.length };
        }

        function saveScore() {
            const scoreData = calculateScore();
            console.log('Saving score:', scoreData);
            
            update(ref(db, 'game/scores/' + localState.playerId), {
                name: localState.playerName,
                score: scoreData.score,
                correct: scoreData.correct,
                total: scoreData.total
            }).then(() => {
                console.log('Score saved successfully!');
            }).catch((error) => {
                console.error('Error saving score:', error);
            });
        }

        function showResults() {
            document.getElementById('quizScreen').classList.remove('active');
            document.getElementById('waitingScreen').classList.remove('active');
            document.getElementById('resultsScreen').classList.add('active');

            const scoreData = calculateScore();
            document.getElementById('yourScore').textContent = scoreData.score + ' points (' + scoreData.correct + '/' + scoreData.total + ')';
            
            // Leaderboard disabled
        }
    </script>
</body>
</html>
